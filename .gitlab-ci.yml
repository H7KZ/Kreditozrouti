# .gitlab-ci.yml


stages:
  - verify
  - deploy



# --- VERIFICATION JOB (for Merge Requests) ---
verify_code:
  stage: verify
  image: node:20-slim
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - ~/.pnpm-store
    policy: pull-push
  before_script:
    - apt-get update -y && apt-get install -y make
    - npm install -g pnpm
    - pnpm install --frozen-lockfile
  script:
    - echo "Running lint and build checks..."
    - make lint
    - make build
    - echo "‚úÖ Verification successful!"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'



# --- DEPLOYMENT TEMPLATE ---
.deploy_template:
  stage: deploy
  image: ubuntu:latest
  before_script:
    - apt-get update -y && apt-get install -y openssh-client git
    - eval $(ssh-agent -s)
    # Decode the Base64 key and add it to the agent
    - echo "$SSH_PRIVATE_KEY" | base64 -d | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "StrictHostKeyChecking no" >> ~/.ssh/config



# --- PRODUCTION DEPLOYMENT JOB ---
deploy_to_production:
  extends: .deploy_template
  script:
    # SAFETY CHECK: Ensure the tag being deployed is on the main branch
    - echo "Verifying tag is on the main branch..."
    - git fetch
    - |
      if ! git branch -r --contains "$CI_COMMIT_SHA" | grep -wq "origin/main"; then
        echo "‚ùå ERROR: Tag '$CI_COMMIT_TAG' is not on the 'main' branch. Halting production deployment."
        exit 1
      fi
    - echo "‚úÖ Verification successful. Proceeding with deployment."
    
    # Deployment steps
    - ssh -p $SSH_PORT $SSH_USERNAME@$SSH_HOST "rm -rf /$SSH_USERNAME/diar-4fis"
    - scp -r -P $SSH_PORT ./* $SSH_USERNAME@$SSH_HOST:/$SSH_USERNAME/diar-4fis/
    - |
        ssh -p $SSH_PORT $SSH_USERNAME@$SSH_HOST << EOF
        set -e
        cd ~/diar-4fis
        cp ~/.env.prod ./.env
        bash ./deployment.sh diar-4fis
        EOF
  rules:
    # This job runs ONLY for version tags (e.g., v1.2.3).
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/'



# --- DEVELOPMENT DEPLOYMENT JOB ---
deploy_to_development:
  extends: .deploy_template
  script:
    - echo "üöÄ Deploying to development server..."
    - ssh -p $SSH_PORT $SSH_USERNAME@$SSH_HOST "rm -rf ~/diar-4fis-dev"
    - scp -r -P $SSH_PORT ./* $SSH_USERNAME@$SSH_HOST:~/diar-4fis-dev/
    - |
        ssh -p $SSH_PORT $SSH_USERNAME@$SSH_HOST << EOF
        set -e
        cd ~/diar-4fis-dev
        cp ~/.env.dev ./.env
        bash ./deployment.sh diar-4fis-dev
        EOF
  rules:
    # This job runs ONLY on pushes to the 'develop' branch.
    - if: '$CI_COMMIT_BRANCH == "develop"'
