# .gitlab-ci.yml

stages:
  - verify
  - deploy



# --- VERIFICATION JOB (for Merge Requests) ---
verify_code:
  stage: verify
  image: node:20-slim
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - ~/.pnpm-store
    policy: pull-push
  before_script:
    - apt-get update -y && apt-get install -y make
    - npm install -g pnpm
    - export PNPM_HOME="/root/.local/share/pnpm"
    - export PATH="$PNPM_HOME:$PATH"
  script:
    - echo "Running install, lint and build checks..."
    - make install
    - make lint
    - make build
    - echo "âœ… Verification successful!"
  rules:
    # 1. RUN on Merge Requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    # 2. DO NOT RUN on standard branch pushes (main/develop)
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: never



# --- DEPLOYMENT TEMPLATE ---
.deploy_template:
  stage: deploy
  image: ubuntu:latest
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client wget gnupg -y )'
    - wget -qO- https://get.docker.com/gpg | apt-key add -
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - touch ~/.ssh/config
    - touch ~/.ssh/known_hosts
    - chmod -R 400 ~/.ssh
    - ssh-keyscan -p $SSH_PORT $SSH_HOST >> ~/.ssh/known_hosts
    - '[[ -f /.dockerinit ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'

#    - 'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client git -y )'
#    - eval $(ssh-agent -s)
#    - mkdir -p ~/.ssh
#    - chmod 700 ~/.ssh
#    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | base64 -d > ~/.ssh/id_rsa
#    - chmod 600 ~/.ssh/id_rsa
#    # Append a newline to the file.
#    # OpenSSH often fails with "libcrypto" or "invalid format" if this is missing.
#    - echo "" >> ~/.ssh/id_rsa
#    - ssh-add ~/.ssh/id_rsa
#    - ssh-keyscan -p $SSH_PORT $SSH_HOST >> ~/.ssh/known_hosts
#    - chmod 644 ~/.ssh/known_hosts
#    -



# --- PRODUCTION DEPLOYMENT JOB ---
deploy_to_production:
  extends: .deploy_template
  script:
    - echo "ðŸš€ Deploying to production server..."
    - ssh -p $SSH_PORT $SSH_USERNAME@$SSH_HOST "rm -rf /$SSH_USERNAME/diar-4fis"
    - scp -r -P $SSH_PORT ./* $SSH_USERNAME@$SSH_HOST:/$SSH_USERNAME/diar-4fis/
    - |
      ssh -p $SSH_PORT $SSH_USERNAME@$SSH_HOST << EOF
      set -e
      cd ~/diar-4fis
      cp ~/.env.prod ./.env
      bash ./deployment/environment.sh diar-4fis prod
      EOF
  rules:
    # This job runs ONLY for version tags (e.g., v1.2.3).
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/'



# --- DEVELOPMENT DEPLOYMENT JOB ---
deploy_to_development:
  extends: .deploy_template
  script:
    - echo "ðŸš€ Deploying to development server..."
    - ssh -p $SSH_PORT $SSH_USERNAME@$SSH_HOST "rm -rf ~/diar-4fis-dev"
    - scp -r -P $SSH_PORT ./* $SSH_USERNAME@$SSH_HOST:~/diar-4fis-dev/
    - |
      ssh -p $SSH_PORT $SSH_USERNAME@$SSH_HOST << EOF
      set -e
      cd ~/diar-4fis-dev
      cp ~/.env.dev ./.env
      bash ./deployment/environment.sh diar-4fis-dev dev
      EOF
  rules:
    # This job runs ONLY for development tags (e.g., dev-1.2.3).
    - if: '$CI_COMMIT_TAG =~ /^dev-[0-9]+\.[0-9]+\.[0-9]+$/'
