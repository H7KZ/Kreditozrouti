name: Upload Repository to VPS

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to upload'
        required: true
        default: 'main'
        type: string
      target_folder:
        description: 'Target folder on VPS (relative to home)'
        required: true
        default: 'repository'
        type: string
      clean_target:
        description: 'Remove existing files before upload'
        required: true
        default: true
        type: boolean

jobs:
  upload:
    name: Upload to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Display Configuration
        run: |
          echo "Upload Configuration:"
          echo "Branch: ${{ inputs.branch }}"
          echo "Target: ~/${{ inputs.target_folder }}"
          echo "Clean: ${{ inputs.clean_target }}"

      - name: Upload Repository
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "."
          target: "~/${{ inputs.target_folder }}"
          rm: ${{ inputs.clean_target }}

      - name: Verify Upload
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "Repository uploaded successfully."
            du -sh ~/${{ inputs.target_folder }}
