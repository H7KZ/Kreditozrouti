name: Production Deployment

on:
  push:
    tags:
      - 'v*.*.*'

env:
  REGISTRY: ghcr.io

jobs:
  build:
    name: Build and Push Images
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.version.outputs.tag }}
      image_prefix: ${{ steps.version.outputs.image_prefix }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Extract Version Tag
        id: version
        run: |
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "image_prefix=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push API
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./api/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.version.outputs.image_prefix }}/api:${{ steps.version.outputs.tag }}
            ${{ env.REGISTRY }}/${{ steps.version.outputs.image_prefix }}/api:latest
          cache-from: type=gha,scope=api
          cache-to: type=gha,mode=max,scope=api
          platforms: linux/amd64

      - name: Build and Push Client
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./client/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.version.outputs.image_prefix }}/client:${{ steps.version.outputs.tag }}
            ${{ env.REGISTRY }}/${{ steps.version.outputs.image_prefix }}/client:latest
          cache-from: type=gha,scope=client
          cache-to: type=gha,mode=max,scope=client
          platforms: linux/amd64

      - name: Build and Push Scraper
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./scraper/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.version.outputs.image_prefix }}/scraper:${{ steps.version.outputs.tag }}
            ${{ env.REGISTRY }}/${{ steps.version.outputs.image_prefix }}/scraper:latest
          cache-from: type=gha,scope=scraper
          cache-to: type=gha,mode=max,scope=scraper
          platforms: linux/amd64

  deploy:
    name: Deploy to Production
    needs: build
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Version Directory
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            mkdir -p ~/versions/production/${{ needs.build.outputs.image_tag }}

      - name: Upload Deployment Files
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "deployment/*"
          target: "~/versions/production/${{ needs.build.outputs.image_tag }}"
          strip_components: 1

      - name: Execute Deployment
        uses: appleboy/ssh-action@v1
        env:
          GH_TOKEN: ${{ secrets.GHCR_TOKEN }}
          GH_ACTOR: ${{ github.actor }}
          IMG_REGISTRY: ${{ env.REGISTRY }}
          IMG_PREFIX: ${{ needs.build.outputs.image_prefix }}
          IMG_TAG: ${{ needs.build.outputs.image_tag }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          envs: GH_TOKEN,GH_ACTOR,IMG_REGISTRY,IMG_PREFIX,IMG_TAG
          script: |
            set -euo pipefail
            
            VERSION_DIR="$HOME/versions/production/$IMG_TAG"
            CURRENT_LINK="$HOME/versions/production/current"
            VARIABLES_DIR="$HOME/variables"
            ENV_NAME="production"
            PROJECT_NAME="prod"
            
            echo "Starting Deployment: $IMG_TAG"
            
            if [ -f "$VARIABLES_DIR/.env.prod" ]; then
                cp "$VARIABLES_DIR/.env.prod" "$VERSION_DIR/$ENV_NAME/.env"
            else
                echo "Error: .env.prod not found in variables directory."
                exit 1
            fi
            
            # Save registry credentials
            cat > "$VERSION_DIR/.registry" << EOF
            IMAGE_REGISTRY=$IMG_REGISTRY
            IMAGE_PREFIX=$IMG_PREFIX
            IMAGE_TAG=$IMG_TAG
            GHCR_USER=$GH_ACTOR
            GHCR_TOKEN=$GH_TOKEN
            EOF
            chmod 600 "$VERSION_DIR/.registry"
            
            # Login and Export
            echo "$GH_TOKEN" | docker login ghcr.io -u "$GH_ACTOR" --password-stdin
            
            export IMAGE_REGISTRY="$IMG_REGISTRY"
            export IMAGE_PREFIX="$IMG_PREFIX"
            export IMAGE_TAG="$IMG_TAG"
            
            # Run Deployment
            cd "$VERSION_DIR"
            bash ./deploy.sh "$PROJECT_NAME" "$ENV_NAME"
            
            # Update Link
            ln -sfn "$VERSION_DIR" "$CURRENT_LINK"
            
            echo "Deployment to Production completed successfully."
