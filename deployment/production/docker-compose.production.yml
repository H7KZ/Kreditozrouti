# ==============================================================================
# Docker Compose: Production Environment
# Description: Full application stack for production deployment.
#
# Services:
#   - api: Backend API service (NestJS/Express)
#   - client: Frontend client (React/Next.js)
#   - scraper: Background scraper workers
#   - mysql: Database server
#   - redis: Cache and queue server
#   - phpmyadmin: Database management UI
#
# Required Environment Variables:
#   - IMAGE_REGISTRY, IMAGE_PREFIX, IMAGE_TAG: Container image references
#   - DOMAIN: Primary domain for routing
#   - PROJECT: Project name for Traefik labels
#   - MYSQL_*: Database credentials
#   - REDIS_*: Cache credentials
#   - API_*: API configuration
#
# Usage: docker compose -f docker-compose.production.yml up -d
# ==============================================================================

services:
  # ============================================================================
  # API Service
  # ============================================================================
  api:
    image: ${IMAGE_REGISTRY}/${IMAGE_PREFIX}/api:${IMAGE_TAG:-latest}
    restart: unless-stopped

    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

    environment:
      - ENV=production
      - API_PORT=80
      - API_URI=https://${DOMAIN}/api
      - API_DOMAIN=${DOMAIN}
      - API_ALLOWED_ORIGINS=https://${DOMAIN}
      - API_SESSION_SECRET=${API_SESSION_SECRET}
      - API_COMMAND_TOKEN=${API_COMMAND_TOKEN}
      - API_FILE_DESTINATION=/usr/src/uploads
      - GOOGLE_USER=${GOOGLE_USER}
      - GOOGLE_APP_PASSWORD=${GOOGLE_APP_PASSWORD}
      - CLIENT_URI=https://${DOMAIN}
      - MYSQL_URI=${MYSQL_URI}
      - REDIS_URI=${REDIS_URI}
      - REDIS_PASSWORD=${REDIS_PASSWORD}

    networks:
      - traefik-network
      - mysql-network
      - redis-network

    labels:
      # Traefik Configuration
      - "traefik.enable=true"
      - "traefik.http.routers.${PROJECT}-api.priority=100"
      - "traefik.http.routers.${PROJECT}-api.rule=Host(`${DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.${PROJECT}-api.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT}-api.tls=true"
      - "traefik.http.routers.${PROJECT}-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.${PROJECT}-api.loadbalancer.server.port=80"
      # Middlewares
      - "traefik.http.routers.${PROJECT}-api.middlewares=${PROJECT}-api-stripprefix,${PROJECT}-api-redirect-www"
      - "traefik.http.middlewares.${PROJECT}-api-stripprefix.stripprefix.prefixes=/api"
      - "traefik.http.middlewares.${PROJECT}-api-redirect-www.redirectregex.regex=^https://www\\.(.*)"
      - "traefik.http.middlewares.${PROJECT}-api-redirect-www.redirectregex.replacement=https://$${1}"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    deploy:
      mode: replicated
      replicas: 2
      resources:
        limits:
          cpus: "1"
          memory: 1024M
        reservations:
          cpus: "0.25"
          memory: 256M
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 10s
        order: stop-first

  # ============================================================================
  # Scraper Service
  # ============================================================================
  scraper:
    image: ${IMAGE_REGISTRY}/${IMAGE_PREFIX}/scraper:${IMAGE_TAG:-latest}
    restart: unless-stopped

    depends_on:
      redis:
        condition: service_healthy

    environment:
      - ENV=production
      - REDIS_URI=${REDIS_URI}
      - REDIS_PASSWORD=${REDIS_PASSWORD}

    networks:
      - redis-network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    deploy:
      mode: replicated
      replicas: 5
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M
      update_config:
        parallelism: 2
        delay: 5s
        order: start-first

  # ============================================================================
  # Client Service
  # ============================================================================
  client:
    image: ${IMAGE_REGISTRY}/${IMAGE_PREFIX}/client:${IMAGE_TAG:-latest}
    restart: unless-stopped

    depends_on:
      - api

    environment:
      - ENV=production

    networks:
      - traefik-network

    labels:
      # Traefik Configuration
      - "traefik.enable=true"
      - "traefik.http.routers.${PROJECT}-client.priority=10"
      - "traefik.http.routers.${PROJECT}-client.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.${PROJECT}-client.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT}-client.tls=true"
      - "traefik.http.routers.${PROJECT}-client.tls.certresolver=letsencrypt"
      - "traefik.http.services.${PROJECT}-client.loadbalancer.server.port=80"
      # Middlewares
      - "traefik.http.routers.${PROJECT}-client.middlewares=${PROJECT}-client-redirect-www"
      - "traefik.http.middlewares.${PROJECT}-client-redirect-www.redirectregex.regex=^https://www\\.(.*)"
      - "traefik.http.middlewares.${PROJECT}-client-redirect-www.redirectregex.replacement=https://$${1}"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    deploy:
      mode: replicated
      replicas: 3
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first

  # ============================================================================
  # Database (MySQL)
  # ============================================================================
  mysql:
    image: mysql:8.4
    restart: unless-stopped

    volumes:
      - mysql-data-volume:/var/lib/mysql

    environment:
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}

    networks:
      - mysql-network

    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

    deploy:
      mode: global
      resources:
        limits:
          cpus: "2"
          memory: 2048M
        reservations:
          cpus: "0.5"
          memory: 512M

  # ============================================================================
  # Database Interface (phpMyAdmin)
  # ============================================================================
  phpmyadmin:
    image: phpmyadmin:5
    restart: unless-stopped

    depends_on:
      mysql:
        condition: service_healthy

    environment:
      - PMA_ARBITRARY=1
      - PMA_HOST=mysql
      - PMA_PORT=3306
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - PMA_ABSOLUTE_URI=https://${DOMAIN}/phpmyadmin/

    networks:
      - traefik-network
      - mysql-network

    labels:
      # Traefik Configuration
      - "traefik.enable=true"
      - "traefik.http.routers.${PROJECT}-phpmyadmin.priority=80"
      - "traefik.http.routers.${PROJECT}-phpmyadmin.rule=Host(`${DOMAIN}`) && PathPrefix(`/phpmyadmin`)"
      - "traefik.http.routers.${PROJECT}-phpmyadmin.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT}-phpmyadmin.tls=true"
      - "traefik.http.routers.${PROJECT}-phpmyadmin.tls.certresolver=letsencrypt"
      - "traefik.http.services.${PROJECT}-phpmyadmin.loadbalancer.server.port=80"
      # Middlewares
      - "traefik.http.routers.${PROJECT}-phpmyadmin.middlewares=${PROJECT}-phpmyadmin-stripprefix"
      - "traefik.http.middlewares.${PROJECT}-phpmyadmin-stripprefix.stripprefix.prefixes=/phpmyadmin"

    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

    deploy:
      mode: global
      resources:
        limits:
          cpus: "0.5"
          memory: 512M

  # ============================================================================
  # Cache (Redis)
  # ============================================================================
  redis:
    image: redis:7-alpine
    restart: unless-stopped

    command:
      - redis-server
      - --save
      - "60"
      - "1"
      - --loglevel
      - warning
      - --requirepass
      - ${REDIS_PASSWORD}
      - --maxmemory
      - 256mb
      - --maxmemory-policy
      - allkeys-lru

    networks:
      - redis-network

    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

    deploy:
      mode: global
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M
